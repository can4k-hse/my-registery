jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy via PM2 on Remote VM
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            set -e

            # –ï—Å–ª–∏ –µ—â—ë –Ω–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ ‚Äî –∫–ª–æ–Ω–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ SSH
            if [ ! -d .git ]; then
              echo "üîÑ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ SSH..."
              git clone git@github.com:${{ github.repository }} . --branch main --depth 1
            else
              echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
              git reset --hard
              git pull
            fi

            echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
            npm install -g pm2
            npm install ‚Äîg verdaccio

            echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
            pm2 stop all || echo "‚ö†Ô∏è –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2"
            pm2 delete all || echo "‚ö†Ô∏è –ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"

            pm2 start verdaccio ‚Äî ‚Äî listen 0.0.0.0:4001

            echo "‚úÖ PM2 –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            pm2 list

            echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ nginx..."
            sudo nginx -t
            sudo systemctl reload nginx

             echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          '
      - name: Report Success
        if: success()
        run: echo "‚úÖ Deploy is successfull!"

      - name: Report Failure
        if: failure()
        run: echo "‚ùå Fail to deploy on VM!"
