name: Deploy to VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy via PM2 on Remote VM
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            set -e

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –æ–±–æ–ª–æ—á–∫–∏
            if [ -f ~/.bashrc ]; then
              source ~/.bashrc
            elif [ -f ~/.profile ]; then
              source ~/.profile
            fi

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É
            echo "üîÑ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É.."
            mkdir -p my-registry
            cd my-registry

            # –ï—Å–ª–∏ –µ—â—ë –Ω–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ ‚Äî –∫–ª–æ–Ω–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ SSH
            if [ ! -d .git ]; then
              echo "üîÑ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ SSH..."
              git clone git@github.com:${{ github.repository }} . --branch main --depth 1
            else
              echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
              git reset --hard
              git pull
            fi

            # –Ø–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º nvm (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
             echo "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º npm.."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é Node.js (—É–∫–∞–∂–∏ —Å–≤–æ—é!)
            nvm use 21.7.0 || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ Node.js 18"; exit 1; }

            echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
            npm install -g pm2
            npm install -g verdaccio

            echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
            pm2 stop all || echo "‚ö†Ô∏è –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2"
            pm2 delete all || echo "‚ö†Ô∏è –ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"

            pm2 start verdaccio -- --listen 0.0.0.0:4001

            echo "‚úÖ PM2 –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            pm2 list

            echo "üîÑ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx..."
            
            # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω –ª–µ–∂–∏—Ç –≤ —Ä–µ–ø–æ)
            sudo cp nginx/verdaccio.conf /etc/nginx/sites-available/verdaccio
            
            # –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            if [ ! -L /etc/nginx/sites-enabled/verdaccio ]; then
              echo "üîó –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫—É..."
              sudo ln -s /etc/nginx/sites-available/verdaccio /etc/nginx/sites-enabled/verdaccio
            else
              echo "‚úÖ –°–∏–º–ª–∏–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥ nginx..."
            sudo nginx -t
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx..."
            sudo systemctl reload nginx

            echo "‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          '

      - name: Report Success
        if: success()
        run: echo "‚úÖ Deploy is successfull!"

      - name: Report Failure
        if: failure()
        run: echo "‚ùå Fail to deploy on VM!"
